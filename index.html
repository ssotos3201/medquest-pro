<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MedQuest Pro ‚Äî UCY + Super Admin + Must-Read Banners + Rankings</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{--indigo:#6366f1;--violet:#7c3aed;--bg1:#667eea;--bg2:#764ba2}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);min-height:100vh;color:#111827}
  .container{max-width:1200px;margin:0 auto;padding:20px}
  .header{backdrop-filter:blur(10px);background:rgba(255,255,255,.95);border-radius:14px;padding:16px 20px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.12);display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .logo{font-size:26px;font-weight:900;background:linear-gradient(45deg,#111,#444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:.3px}
  .nav-buttons{display:flex;gap:8px;flex-wrap:wrap}
  .btn{padding:10px 14px;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:800;transition:.2s}
  .btn-primary{background:linear-gradient(45deg,var(--indigo),var(--violet));color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(99,102,241,.35)}
  .btn-secondary{background:#f3f4f6;color:#111827}
  .btn-secondary:hover{background:#e5e7eb}
  .btn-success{background:#10b981;color:#fff}
  .btn-warning{background:#f59e0b;color:#111}
  .btn-danger{background:#ef4444;color:#fff}
  .btn-outline{background:#fff;border:1px solid #e5e7eb}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:12px;background:#eef2ff;color:#3730a3}
  .main-content{background:rgba(255,255,255,.98);border-radius:14px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.12);min-height:520px}
  .grid{display:grid;gap:16px}
  .stats-grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin-bottom:16px}
  .stat-card{background:linear-gradient(135deg,var(--indigo) 0%,var(--violet) 100%);color:#fff;padding:18px;border-radius:14px;text-align:center}
  .stat-value{font-size:30px;font-weight:900;margin-bottom:4px}
  .stat-label{font-size:13px;opacity:.9}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.96),rgba(255,255,255,.92));border:1px solid #e5e7eb;border-radius:14px;padding:16px}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px;margin:12px 0}
  .table thead th{font-size:12px;text-transform:uppercase;letter-spacing:.06em;background:#eef2ff;color:#3730a3;padding:10px;border-radius:10px}
  .table tbody tr{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.05)}
  .table td{padding:10px;border-top:1px solid #f3f4f6;border-bottom:1px solid #f3f4f6;vertical-align:top}
  .badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:800}
  .badge-green{background:#ecfdf5;color:#065f46}
  .badge-yellow{background:#fffbeb;color:#92400e}
  .badge-indigo{background:#eef2ff;color:#3730a3}
  .badge-red{background:#fee2e2;color:#991b1b}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f3f4f6;color:#374151;font-size:12px;font-weight:800}
  .u-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px}
  .tabbar{display:flex;gap:8px;margin-bottom:16px;border-bottom:2px solid #e5e7eb;flex-wrap:wrap}
  .tab-btn{padding:10px 14px;background:transparent;border:none;border-bottom:3px solid transparent;cursor:pointer;font-weight:900;color:#6b7280}
  .tab-btn.active{color:var(--indigo);border-bottom-color:var(--indigo)}
  .tab-content{display:none}.tab-content.active{display:block}
  .searchbar{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:8px;margin:8px 0}
  .searchbar input,.searchbar select,.searchbar textarea{padding:10px;border:1px solid #e5e7eb;border-radius:10px;width:100%;background:#fff}
  .two-col{display:grid;grid-template-columns:280px 1fr;gap:14px}
  @media (max-width:900px){.two-col{grid-template-columns:1fr}}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .muted{color:#6b7280}
  .nowrap{white-space:nowrap}
  .img-preview{max-width:100%;border:1px solid #e5e7eb;border-radius:10px}
  /* Must-Read Banner Modal minimal (unchanged visuals) */
  .banner-modal{position:fixed;inset:0;z-index:2000;display:none;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.28), rgba(0,0,0,.55));backdrop-filter:blur(8px)}
  .banner-modal.show{display:flex}
  .banner-card{width:min(920px,92vw);border-radius:18px;background:#fff;box-shadow:0 30px 80px rgba(0,0,0,.35);overflow:hidden;border:1px solid rgba(255,255,255,.55)}
  .banner-head{padding:18px 20px;background:linear-gradient(90deg, rgba(99,102,241,.2), rgba(124,58,237,.2));display:flex;align-items:center;gap:12px}
  .banner-title{font-size:20px;font-weight:900}
  .banner-body{padding:18px 20px;max-height:55vh;overflow:auto}
  .banner-actions{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.8))}
  .ack-row{display:flex;gap:10px;align-items:center}
  .ack-row input{width:18px;height:18px}
  .btn-disabled{opacity:.5;pointer-events:none}
  .delta-up{color:#065f46;font-weight:800}
  .delta-down{color:#991b1b;font-weight:800}
</style>

<!-- ‚úÖ Load Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="logo">üè• MedQuest Pro</div>
      <div id="announcementBar"></div>
    </div>
    <div class="nav-buttons" id="navButtons"></div>
  </div>
  <div class="main-content" id="mainContent"></div>
</div>


<!-- Admin Modal -->
<div id="modal" style="display:none;position:fixed;inset:0;z-index:1000;align-items:center;justify-content:center;background:rgba(0,0,0,.45)">
  <div style="background:#fff;border-radius:14px;padding:20px;max-width:980px;width:95%;max-height:86vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h2 id="modalTitle">Modal</h2>
      <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<!-- Must-Read Banner Modal -->
<div class="banner-modal" id="bannerModal" aria-modal="true" role="dialog">
  <div class="banner-card" role="document">
    <div class="banner-head">
      <span class="badge badge-red">Must-Read</span>
      <div id="bannerTitle" class="banner-title">Title</div>
      <div class="muted" id="bannerInfo" style="margin-left:auto"></div>
    </div>
    <div class="banner-body" id="bannerBody"></div>
    <div class="banner-actions">
      <div class="ack-row">
        <input type="checkbox" id="bannerAckChk" onchange="toggleBannerAck()">
        <label for="bannerAckChk"><b>I‚Äôve read and understood this notice.</b></label>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="muted" id="bannerProgress"></span>
        <button class="btn btn-secondary" onclick="skipBanner()" id="bannerSkipBtn">Skip</button>
        <button class="btn btn-primary btn-disabled" id="bannerCloseBtn" onclick="ackAndCloseBanner()" disabled>Close & Continue</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ============================== SUPABASE (keys inside script) ============================== */
const SUPABASE_URL = "https://vvcymegonxwjkmcruxek.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2Y3ltZWdvbnh3amttY3J1eGVrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2MTA2MjcsImV4cCI6MjA3ODE4NjYyN30.SA3esiKtlaKVz8V1cBWgVtsps6vg55jlZpWao9jynFM";
const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);
/* (Optional) You can later replace localStorage saves with Supabase CRUD using `sb` */

/* ============================== ROLES / PERMS ============================== */
const ROLE_PRESETS = {
  admin: {'*':true, superadmin:true},
  ucy_staff: {'ucy.import':true,'ucy.staff.view':true,'ucy.staff.edit':true,'users.read':true},
  ucy_tutor: {'ucy.tutor.upload':true,'ucy.tutor.bulk_qs':true,'ucy.tutor.manage_docs':true,'media.upload':true,'questions.create':true,'questions.update':true,'questions.read':true},
  ucy_student: {'questions.read':true},
  user: {'questions.read':true}
};

const PERMISSION_CATALOG = [
  '*','sudo.impersonate','sudo.maintenance','sudo.announcements','sudo.feature_flags','sudo.backup','sudo.restore','sudo.audit.view','sudo.taxonomy.edit',
  'users.read','users.create','users.update','users.delete','users.password.reset','users.force.logout','users.export','users.import',
  'roles.read','roles.update','permissions.assign',
  'questions.read','questions.create','questions.update','questions.delete','media.upload','media.delete',
  'plans.read','plans.create','plans.update','plans.delete','billing.view','billing.refund',
  'analytics.view','logs.view',
  'ucy.staff.view','ucy.staff.edit','ucy.import','ucy.tutor.upload','ucy.tutor.manage_docs','ucy.tutor.bulk_qs'
];

/* ============================== TAXONOMY ============================== */
const SPECIALTIES = {
  "Anatomy":["Head & Neck","Thorax","Abdomen","Pelvis/Perineum","Upper Limb","Lower Limb","Neuroanatomy"],
  "Anaesthetics":["General","Regional","Pain Medicine","ICU Interface"],
  "Cardiology":["Heart Failure","Ischaemic Heart Disease","Arrhythmias","Valvular","Adult Congenital","Cardio-Oncology","Imaging"],
  "Dermatology":["Inflammatory","Infectious","Tumours","Hair & Nails","Pediatric Derm"],
  "Emergency Medicine":["Resuscitation","Toxicology","Trauma","Pediatrics","Prehospital"],
  "Endocrinology":["Diabetes","Thyroid","Adrenal","Pituitary","Calcium/Bone","Reproductive"],
  "ENT (Otolaryngology)":["Otology","Rhinology","Laryngology","Head & Neck","Pediatric ENT"],
  "Gastroenterology":["Hepatology","IBD","UGI","LGI","Pancreatology","Nutrition"],
  "General Practice / Family Medicine":["Chronic Disease","Women‚Äôs Health","Child Health","Mental Health","Geriatrics"],
  "General Surgery":["HPB","Colorectal","Upper GI","Breast","Endocrine","Transplant (interface)","Trauma & Emergency"],
  "Geriatric Medicine":["Falls & Frailty","Cognitive Disorders","Polypharmacy","Rehab"],
  "Hematology":["Benign","Malignant","Transfusion","Hemostasis/Thrombosis"],
  "Infectious Diseases":["Sepsis","HIV","TB","Tropical","Antimicrobials","Outbreaks"],
  "Intensive Care":["Ventilation","Shock","Renal Replacement","Sedation/Analgesia","Nutrition"],
  "Medical Education":["Curriculum","Assessment","OSCE Design","Simulation"],
  "Nephrology":["AKI","CKD","Glomerular","Dialysis","Transplant Medicine"],
  "Neurology":["Stroke","Epilepsy","MS/NMOSD","Movement","Neuromuscular","Headache"],
  "Neurosurgery":["Vascular","Spine","Tumour","Trauma","Functional"],
  "Obstetrics & Gynaecology":["Antenatal","Intrapartum","Postnatal","Gynecologic Oncology","Reproductive Medicine","Urogyne"],
  "Oncology":["Breast","GI","GU","Lung","Head & Neck","Hemato-oncology","Palliative Interface"],
  "Ophthalmology":["Cornea","Glaucoma","Retina","Uveitis","Neuro-ophthalmology","Pediatric"],
  "Orthopaedics":["Trauma","Spine","Sports","Arthroplasty","Upper Limb","Foot & Ankle"],
  "Paediatrics":["Neonatology","Cardiology","Infectious","Respiratory","Neurology","Endocrine","Gastro","Renal"],
  "Palliative Care":["Symptom Control","End-of-Life","Ethics","Communication"],
  "Plastic Surgery":["Burns","Hand","Craniofacial","Aesthetic","Reconstruction"],
  "Psychiatry":["Adult","Child & Adolescent","Old Age","Liaison","Addictions","Forensic"],
  "Public Health (Policy)":["Health Economics","Systems","Law & Ethics","Quality & Safety"],
  "Radiology":["Neuroradiology","MSK","Chest","Abdo/Pelvis","Breast","Interventional"],
  "Rheumatology":["Inflammatory Arthritis","CTD/Vasculitis","Metabolic Bone","Soft Tissue"],
  "Sports & Exercise Medicine":["Injury","Rehab","Exercise Physiology","Concussion"],
  "Urology":["Oncology","Stones","BPH/LUTS","Andrology","Pediatric Urology"],
  "Vascular Surgery":["Aneurysm","Peripheral Arterial","Venous","Dialysis Access"],
  "Research & Statistics":["Study Design","Critical Appraisal","Biostats","EBM"]
};

/* ============================== STATE ============================== */
let state = {
  features:{ ucysOnlyVisibleToUCY:true, allowGeneralDownloadTutorDocs:false, maintenance:false, readOnly:false, announcement:'', banners:[] },
  currentUser:null,
  sudoOriginalUser:null,
  users:[
    { id:1,email:'admin@medquest.com',password:'admin123',role:'admin',name:'Admin User',subscription:'premium',permissions:{'*':true},superadmin:true },
    { id:2,email:'user@example.com',password:'user123',role:'user',name:'John Doe',subscription:'basic',permissions:{...ROLE_PRESETS.user} },
    { id:3,email:'staff@ucy.ac.cy',password:'staff123',role:'ucy_staff',name:'UCY Staff',subscription:null,permissions:{...ROLE_PRESETS.ucy_staff} },
    { id:4,email:'tutor@ucy.ac.cy',password:'tutor123',role:'ucy_tutor',name:'UCY Tutor',subscription:null,permissions:{...ROLE_PRESETS.ucy_tutor} },
    { id:5,email:'student@ucy.ac.cy',password:'student123',role:'ucy_student',name:'UCY Student',subscription:null,permissions:{...ROLE_PRESETS.ucy_student} }
  ],
  students:[{ studentId:'S-2001', name:'Eleni Christou', email:'eleni@ucy.ac.cy', year:'4', course:'MBBS', notes:'OSCE prep group A' }],
  ucyDocs:[],
  questions:[
    { id:1, section:'UKMLA', access:'PUBLIC', category:'Cardiology', difficulty:'Easy',
      stem:'Most common cause of HF in developed countries?', imageUrl:null,
      options:['Rheumatic','Ischaemic','Congenital','Hypertensive','Dilated cardiomyopathy'],
      correctIndex:1, explanations:['Less common','Correct','Rare adult cause','Contributor not leading','Not leading'] },
    { id:2, section:'SCENARIO', access:'UCY', category:'Endocrinology', difficulty:'Medium',
      stem:'UCY case: 45-year-old with weight loss & polyuria. Best initial test?', imageUrl:null,
      options:['HbA1c','Fasting insulin','Random insulin','OGTT','C-peptide'],
      correctIndex:0, explanations:['Correct first-line','Not first line','No','Less convenient','No'] }
  ],
  subscriptionPlans:[
    { id:'basic',name:'Basic',price:19.99,features:['100 questions/month','Progress tracking','Mobile access'],featured:false },
    { id:'pro',name:'Professional',price:39.99,features:['Unlimited questions','Detailed explanations','Custom quizzes','Offline mode','Priority support'],featured:true },
    { id:'premium',name:'Premium',price:59.99,features:['Everything in Pro','Video explanations','Live webinars','Personal coach','Exam simulations','Certificate of completion'],featured:false }
  ],
  attempts:[],  // per-question attempts {userId,qid,category,section,correct:boolean,ts}
  auditLog:[]
};

/* ============================== DOM REFS ============================== */
const modalEl=document.getElementById('modal');
const modalTitleEl=document.getElementById('modalTitle');
const modalBodyEl=document.getElementById('modalBody');
const bannerModal=document.getElementById('bannerModal');
const bannerTitleEl=document.getElementById('bannerTitle');
const bannerInfoEl=document.getElementById('bannerInfo');
const bannerBodyEl=document.getElementById('bannerBody');
const bannerAckChk=document.getElementById('bannerAckChk');
const bannerCloseBtn=document.getElementById('bannerCloseBtn');
const bannerProgress=document.getElementById('bannerProgress');

/* ============================== INIT / NAV ============================== */
function init(){
  const savedUser=localStorage.getItem('currentUser');
  if(savedUser){ state.currentUser=JSON.parse(savedUser); }
  const savedFlags=localStorage.getItem('appBackupLive');
  if(savedFlags){
    try{
      const parsed=JSON.parse(savedFlags);
      if(parsed.features) state.features={...state.features, ...parsed.features};
    }catch(_){}
  }
  const savedAttempts=localStorage.getItem('attemptsLog');
  if(savedAttempts){ try{ state.attempts=JSON.parse(savedAttempts)||[]; }catch{} }
  seedDemoBannerOnce();
  updateAnnouncementBar();
  updateNavigation();
  showLanding();
  queueMustReadBanners();
}
window.onload=init;

function isSuperadmin(){ return !!state.currentUser?.superadmin || state.currentUser?.permissions?.['*']; }
function hasPerm(key){ if(!state.currentUser) return false; if(isSuperadmin()) return true; return !!state.currentUser.permissions?.[key]; }

function updateNavigation(){
  const nav=document.getElementById('navButtons');
  if(!state.currentUser){
    nav.innerHTML=`<button class="btn btn-secondary" onclick="showLogin()">Login</button><button class="btn btn-primary" onclick="showRegister()">Sign Up</button>`;
    return;
  }
  const roleChip=`<span class="chip">Role: ${state.currentUser.role}${isSuperadmin()?' ‚Ä¢ SUPERADMIN':''}${state.sudoOriginalUser?' ‚Ä¢ IMPERSONATING':''}</span>`;
  const ucyBtn=['admin','ucy_staff','ucy_tutor','ucy_student'].includes(state.currentUser.role)?`<button class="btn btn-secondary" onclick="showUCYPortal()">UCY Portal</button>`:'';
  const tutorBtn=(state.currentUser.role==='ucy_tutor'||isSuperadmin())?`<button class="btn btn-secondary" onclick="showUCYTutorWorkspace()">Tutor Workspace</button>`:'';
  const adminBtn=(state.currentUser.role==='admin'||state.currentUser.role==='ucy_staff')?`<button class="btn btn-secondary" onclick="showAdminPanel()">Admin Panel</button>`:'';
  const sudoBtn=(isSuperadmin() && state.sudoOriginalUser)?`<button class="btn btn-warning" onclick="sudoRevert()">Exit Impersonation</button>`:'';
  nav.innerHTML=`
    <span style="margin-right:6px;">Welcome, ${state.currentUser.name}</span>
    ${roleChip}
    <button class="btn btn-secondary" onclick="showDashboard()">Dashboard</button>
    <button class="btn btn-secondary" onclick="showBank()">Question Bank</button>
    <button class="btn btn-secondary" onclick="showRankings()">Rankings</button>
    ${ucyBtn}${tutorBtn}${adminBtn}${sudoBtn}
    <button class="btn btn-primary" onclick="logout()">Logout</button>`;
}

function updateAnnouncementBar(){
  const bar=document.getElementById('announcementBar');
  const msgs=[];
  if(state.features.maintenance) msgs.push('<span class="badge badge-red mono">MAINTENANCE MODE</span>');
  if(state.features.readOnly) msgs.push('<span class="badge badge-yellow mono">READ-ONLY</span>');
  if(state.features.announcement) msgs.push(`<span class="badge badge-indigo">${escapeHtml(state.features.announcement)}</span>`);
  bar.innerHTML = msgs.length? `<div class="u-row" style="margin-top:6px">${msgs.join(' ')}</div>`:'';
}

/* ============================== LANDING / AUTH / DASH ============================== */
function showLanding(){
  const c=document.getElementById('mainContent');
  const myAcc = state.currentUser ? (computeUserAccuracy(state.currentUser.id) ?? '‚Äî') : '‚Äî';
  c.innerHTML=`
    <div style="text-align:center;padding:36px 0">
      <h1 style="font-size:44px;margin-bottom:10px;background:linear-gradient(45deg,#111,#333);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">Classic structure, modern feel.</h1>
      <p class="muted" style="font-size:18px;margin-bottom:18px">Everything filed under the specialty it belongs to. No fluff.</p>
      <div class="grid stats-grid">
        <div class="stat-card"><div class="stat-value">${state.questions.length}</div><div class="stat-label">Questions</div></div>
        <div class="stat-card"><div class="stat-value">${state.users.length}</div><div class="stat-label">Users</div></div>
        <div class="stat-card"><div class="stat-value">${state.attempts.length}</div><div class="stat-label">Attempts Logged</div></div>
        <div class="stat-card"><div class="stat-value">${typeof myAcc==='number'?myAcc+'%':'‚Äî'}</div><div class="stat-label">Your Accuracy</div></div>
      </div>
    </div>`;
}
function showLogin(){
  const c=document.getElementById('mainContent');
  c.innerHTML=`
  <div class="card" style="max-width:520px;margin:0 auto">
    <h2 style="text-align:center;margin-bottom:12px">Login</h2>
    <div id="loginMessage"></div>
    <form onsubmit="handleLogin(event)">
      <div class="u-row">
        <div><label>Email</label><input type="email" id="loginEmail" required class="searchbar"></div>
        <div><label>Password</label><input type="password" id="loginPassword" required class="searchbar"></div>
      </div>
      <div style="margin-top:12px"><button class="btn btn-primary" style="width:100%">Login</button></div>
    </form>
    <div style="margin-top:12px;font-size:13px;background:#eff6ff;padding:10px;border-radius:10px">
      <div class="u-row">
        <div><span class="pill">Super Admin</span> admin@medquest.com / admin123</div>
        <div><span class="pill">UCY Staff</span> staff@ucy.ac.cy / staff123</div>
        <div><span class="pill">UCY Tutor</span> tutor@ucy.ac.cy / tutor123</div>
        <div><span class="pill">UCY Student</span> student@ucy.ac.cy / student123</div>
      </div>
    </div>
  </div>`;
}
function handleLogin(e){
  e.preventDefault();
  const email=document.getElementById('loginEmail').value.trim();
  const password=document.getElementById('loginPassword').value;
  const user=state.users.find(u=>u.email===email && u.password===password);
  if(!user){ document.getElementById('loginMessage').innerHTML=`<div class="badge badge-yellow">Check your details.</div>`; return; }
  state.currentUser=user; localStorage.setItem('currentUser',JSON.stringify(user));
  updateNavigation(); updateAnnouncementBar(); showDashboard(); audit('login:'+email);
  queueMustReadBanners();
}
function showRegister(){
  const c=document.getElementById('mainContent');
  c.innerHTML=`
    <div class="card" style="max-width:520px;margin:0 auto">
      <h2 style="text-align:center;margin-bottom:12px">Create Your Account</h2>
      <div id="registerMessage"></div>
      <form onsubmit="handleRegister(event)">
        <div class="u-row"><div><label>Full Name</label><input id="registerName" required class="searchbar"></div>
        <div><label>Email</label><input type="email" id="registerEmail" required class="searchbar"></div></div>
        <div class="u-row"><div><label>Password</label><input type="password" id="registerPassword" required class="searchbar"></div>
        <div><label>Confirm</label><input type="password" id="confirmPassword" required class="searchbar"></div></div>
        <div style="margin-top:8px"><label><input type="checkbox" id="registerAsUCYStudent"> Register as UCY Student</label></div>
        <div style="margin-top:12px"><button class="btn btn-primary" style="width:100%">Sign Up</button></div>
      </form>
    </div>`;
}
function handleRegister(e){
  e.preventDefault();
  const name=document.getElementById('registerName').value.trim();
  const email=document.getElementById('registerEmail').value.trim();
  const pwd=document.getElementById('registerPassword').value;
  const cp=document.getElementById('confirmPassword').value;
  const asUCY=document.getElementById('registerAsUCYStudent').checked;
  if(pwd!==cp){ document.getElementById('registerMessage').innerHTML=`<div class="badge badge-yellow">Passwords must match.</div>`;return; }
  if(state.users.find(u=>u.email===email)){ document.getElementById('registerMessage').innerHTML=`<div class="badge badge-yellow">Email already exists.</div>`;return; }
  const id=state.users.length?Math.max(...state.users.map(u=>u.id))+1:1;
  const role=asUCY?'ucy_student':'user';
  const nu={ id,name,email,password:pwd,role,subscription:null,permissions:{...(ROLE_PRESETS[role]||{})} };
  state.users.push(nu);
  if(asUCY){ state.students.push({ studentId:'S-'+(2000+state.students.length+1), name, email, year:'', course:'MBBS', notes:'' }); }
  state.currentUser=nu; localStorage.setItem('currentUser',JSON.stringify(nu));
  updateNavigation(); updateAnnouncementBar(); showDashboard(); audit('register:'+email);
  queueMustReadBanners();
}
function logout(){
  if(state.currentUser) audit('logout:'+state.currentUser.email);
  state.currentUser=null; state.sudoOriginalUser=null;
  localStorage.removeItem('currentUser');
  updateNavigation(); showLanding();
}
function showDashboard(){
  if(!state.currentUser){ showLogin(); return; }
  const myAcc = computeUserAccuracy(state.currentUser.id);
  const c=document.getElementById('mainContent');
  c.innerHTML=`
    <div>
      <div class="grid stats-grid">
        <div class="stat-card"><div class="stat-value">${state.ucyDocs.length}</div><div class="stat-label">UCY Materials</div></div>
        <div class="stat-card"><div class="stat-value">${state.questions.length}</div><div class="stat-label">Questions</div></div>
        <div class="stat-card"><div class="stat-value">${state.attempts.length}</div><div class="stat-label">Attempts Logged</div></div>
        <div class="stat-card"><div class="stat-value">${myAcc!=null?myAcc+'%':'‚Äî'}</div><div class="stat-label">Your Accuracy</div></div>
      </div>
      <div class="card">
        <h3>Quick Links</h3>
        <div class="u-row" style="margin-top:8px">
          <button class="btn btn-secondary" onclick="showBank()">Question Bank</button>
          <button class="btn btn-secondary" onclick="showRankings()">Rankings</button>
          <button class="btn btn-secondary" onclick="showUCYPortal()">UCY Portal</button>
          ${(state.currentUser.role==='ucy_tutor'||isSuperadmin())?`<button class="btn btn-secondary" onclick="showUCYTutorWorkspace()">Tutor Workspace</button>`:''}
          ${(state.currentUser.role==='admin'||state.currentUser.role==='ucy_staff')?`<button class="btn btn-secondary" onclick="showAdminPanel()">Admin Panel</button>`:''}
        </div>
      </div>
    </div>`;
}

/* ============================== QUESTION BANK (practice + manage + logging) ============================== */
function showBank(){
  const c=document.getElementById('mainContent');
  c.innerHTML=`
    <div>
      <div class="tabbar">
        <button class="tab-btn active" onclick="switchTab(event,'qb_practice')">Practice</button>
        <button class="tab-btn" onclick="switchTab(event,'qb_manage')">Manage Questions</button>
      </div>

      <div id="qb_practice" class="tab-content active">
        <div class="card">
          <h3>Start a Quiz</h3>
          <div class="u-row" style="margin-top:8px">
            <div>
              <label>Section</label>
              <select id="qp_section" class="searchbar">
                <option value="all">All</option>
                <option>UKMLA</option><option>OSCE</option><option>SCENARIO</option>
              </select>
            </div>
            <div>
              <label>Category</label>
              <select id="qp_category" class="searchbar">
                <option value="all">All</option>
                ${Object.keys(SPECIALTIES).sort().map(s=>`<option>${s}</option>`).join('')}
              </select>
            </div>
            <div>
              <label>Difficulty</label>
              <select id="qp_diff" class="searchbar">
                <option value="all">All</option><option>Easy</option><option>Medium</option><option>Hard</option>
              </select>
            </div>
            <div><label>&nbsp;</label><button class="btn btn-primary" onclick="startQuiz()">Start</button></div>
          </div>
        </div>
      </div>

      <div id="qb_manage" class="tab-content">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Manage Questions</h3>
            <div>
              <button class="btn btn-secondary" onclick="openAddQuestion()">Add Question</button>
              ${(state.currentUser?.role==='ucy_tutor'||isSuperadmin())?`<button class="btn btn-outline" onclick="downloadBulkTemplate()">Bulk Template</button>
              <label class="btn btn-primary" style="cursor:pointer">Import CSV<input type="file" accept=".csv" onchange="importBulkQuestions(event)" style="display:none"></label>`:''}
            </div>
          </div>
          <table class="table">
            <thead><tr><th>ID</th><th>Section</th><th>Category</th><th>Difficulty</th><th>Stem</th><th>Image</th><th>Scope</th><th>Actions</th></tr></thead>
            <tbody>
              ${state.questions.map(q=>`
                <tr>
                  <td>${q.id}</td><td>${q.section}</td><td>${q.category}</td><td>${q.difficulty}</td>
                  <td>${escapeHtml(q.stem).slice(0,80)}${q.stem.length>80?'‚Ä¶':''}</td>
                  <td>${q.imageUrl?'<span class="badge badge-green">Yes</span>':'‚Äî'}</td>
                  <td>${q.access==='UCY'?'<span class="badge badge-yellow">UCY</span>':'<span class="badge badge-green">Public</span>'}</td>
                  <td class="nowrap">
                    <button class="btn btn-secondary" onclick="previewQuestion(${q.id})">Preview</button>
                    <button class="btn btn-danger" onclick="deleteQuestion(${q.id})">Delete</button>
                  </td>
                </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
}
function switchTab(ev,id){ document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(s=>s.classList.remove('active')); ev.target.classList.add('active'); document.getElementById(id).classList.add('active'); }
function startQuiz(){
  const sec=document.getElementById('qp_section').value;
  const cat=document.getElementById('qp_category').value;
  const diff=document.getElementById('qp_diff').value;
  const pool=state.questions.filter(q=>
    (sec==='all'||q.section===sec) &&
    (cat==='all'||q.category===cat) &&
    (diff==='all'||q.difficulty===diff) &&
    (q.access!=='UCY' || ['ucy_student','ucy_tutor','ucy_staff','admin'].includes(state.currentUser?.role))
  );
  if(!pool.length){ alert('No questions match.'); return; }
  runQuiz(pool);
}
let quiz = { list:[], idx:0, answers:{} };
function runQuiz(list){ quiz={list, idx:0, answers:{}}; renderQuiz(); }
function renderQuiz(){
  const q=quiz.list[quiz.idx];
  const c=document.getElementById('mainContent');
  const pct=Math.round(((quiz.idx)/quiz.list.length)*100);
  c.innerHTML=`
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3>Question ${quiz.idx+1} of ${quiz.list.length}</h3>
        <span class="pill">${q.section} ‚Ä¢ ${q.category} ‚Ä¢ ${q.difficulty}</span>
      </div>
      <div class="card">
        <div style="margin-bottom:8px">${escapeHtml(q.stem)}</div>
        ${q.imageUrl?`<img src="${q.imageUrl}" alt="question image" class="img-preview">`:''}
        <div id="opts" style="margin-top:10px">
          ${q.options.map((opt,i)=>`
            <div id="opt_${i}" class="card" style="padding:10px;cursor:pointer;border-left:4px solid transparent" onclick="selectQuiz(${i})">
              <b>${String.fromCharCode(65+i)}.</b> ${escapeHtml(opt)}
              <div id="exp_${i}" class="muted" style="display:none;margin-top:6px">${escapeHtml(q.explanations[i]||'')}</div>
            </div>`).join('')}
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-secondary" onclick="showBank()">Exit</button>
          <button id="submitBtn" class="btn btn-primary btn-disabled" onclick="submitQuiz()" disabled>Submit</button>
          <button id="nextBtn" class="btn btn-primary" style="display:none" onclick="nextQuiz()">Next</button>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="muted">Progress: ${pct}%</div>
        <div style="height:8px;border-radius:999px;background:#f3f4f6;overflow:hidden"><div style="width:${pct}%;height:100%;background:linear-gradient(90deg,var(--indigo),var(--violet))"></div></div>
      </div>
    </div>`;
}
function selectQuiz(i){
  document.querySelectorAll('#opts .card').forEach(el=>el.style.borderLeftColor='transparent');
  document.getElementById('opt_'+i).style.borderLeftColor='var(--indigo)';
  quiz.answers[quiz.list[quiz.idx].id]=i;
  const b=document.getElementById('submitBtn'); b.classList.remove('btn-disabled'); b.disabled=false;
}
function submitQuiz(){
  const q=quiz.list[quiz.idx];
  const sel=quiz.answers[q.id];
  if(sel==null){ return; }
  document.getElementById('submitBtn').style.display='none';
  document.getElementById('nextBtn').style.display='inline-block';
  q.options.forEach((_,i)=>{
    const el=document.getElementById('opt_'+i);
    const exp=document.getElementById('exp_'+i);
    if(i===q.correctIndex){ el.style.borderLeftColor='#10b981'; }
    if(i===sel && sel!==q.correctIndex){ el.style.borderLeftColor='#ef4444'; }
    exp.style.display='block';
  });
  logAttempt(state.currentUser?.id, q.id, q.category, q.section, sel===q.correctIndex);
}
function nextQuiz(){
  quiz.idx++;
  if(quiz.idx<quiz.list.length){ renderQuiz(); }
  else { showQuizResults(); }
}
function showQuizResults(){
  const correct=quiz.list.filter(q=>quiz.answers[q.id]===q.correctIndex).length;
  const score=Math.round((correct/quiz.list.length)*100);
  const c=document.getElementById('mainContent');
  c.innerHTML=`
    <div style="text-align:center;padding:40px">
      <h2>Quiz Complete</h2>
      <div class="stat-card" style="max-width:320px;margin:20px auto"><div class="stat-value">${score}%</div><div class="stat-label">Score</div></div>
      <p>You got ${correct} of ${quiz.list.length} correct.</p>
      <button class="btn btn-primary" onclick="showRankings()">View Rankings</button>
      <button class="btn btn-secondary" onclick="showBank()">Back to Bank</button>
    </div>`;
}

/* Attempt logging & persistence */
function logAttempt(userId,qid,category,section,correct){
  if(!userId) return;
  state.attempts.push({userId,qid,category,section,correct:!!correct,ts:Date.now()});
  localStorage.setItem('attemptsLog', JSON.stringify(state.attempts));
  audit(`attempt:${userId}:${qid}:${correct?'1':'0'}`);
}

/* ============================== ADD/EDIT QUESTIONS ============================== */
function openAddQuestion(){
  openModal('Add Question', `
    <div class="u-row">
      <div><label>Section</label>
        <select id="q_section" class="searchbar"><option>UKMLA</option><option>OSCE</option><option>SCENARIO</option></select>
      </div>
      <div><label>Access</label>
        <select id="q_access" class="searchbar"><option value="PUBLIC">PUBLIC</option><option value="UCY">UCY</option></select>
      </div>
      <div><label>Category</label>
        <select id="q_category" class="searchbar">
          ${Object.keys(SPECIALTIES).sort().map(s=>`<option>${s}</option>`).join('')}
        </select>
      </div>
      <div><label>Difficulty</label>
        <select id="q_diff" class="searchbar"><option>Easy</option><option>Medium</option><option>Hard</option></select>
      </div>
    </div>
    <div style="margin-top:8px"><label>Stem</label><textarea id="q_stem" rows="4" class="searchbar"></textarea></div>
    <div style="margin-top:8px"><label>Image (optional)</label>
      <input type="file" id="q_image" accept="image/*" class="searchbar" />
    </div>
    <div class="u-row" style="margin-top:8px">
      ${['A','B','C','D','E'].map((L,idx)=>`
        <div>
          <label>Option ${L}</label><input id="q_opt_${idx}" class="searchbar">
          <label style="margin-top:6px">Explanation ${L}</label><input id="q_exp_${idx}" class="searchbar">
        </div>`).join('')}
    </div>
    <div class="u-row" style="margin-top:8px">
      <div><label>Correct</label>
        <select id="q_correct" class="searchbar">${['A','B','C','D','E'].map((L,i)=>`<option value="${i}">${L}</option>`).join('')}</select>
      </div>
    </div>
    <div style="margin-top:10px"><button class="btn btn-success" onclick="saveQuestion()">Save</button></div>
  `);
}
function saveQuestion(){
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  const section=document.getElementById('q_section').value;
  const access=document.getElementById('q_access').value;
  const category=document.getElementById('q_category').value;
  const difficulty=document.getElementById('q_diff').value;
  const stem=document.getElementById('q_stem').value.trim();
  const imgInput=document.getElementById('q_image');
  const imageUrl = imgInput.files && imgInput.files[0] ? URL.createObjectURL(imgInput.files[0]) : null;
  const options=[0,1,2,3,4].map(i=>document.getElementById('q_opt_'+i).value.trim());
  const explanations=[0,1,2,3,4].map(i=>document.getElementById('q_exp_'+i).value.trim());
  const correctIndex=parseInt(document.getElementById('q_correct').value,10);
  if(!stem || options.some(x=>!x) || explanations.some(x=>!x)){ alert('Fill stem, all options and explanations.'); return; }
  const id=state.questions.length?Math.max(...state.questions.map(q=>q.id))+1:1;
  state.questions.push({id,section,access,category,difficulty,stem,imageUrl,options,explanations,correctIndex});
  closeModal(); showBank(); audit('questions.create:'+id);
}
function previewQuestion(id){
  const q=state.questions.find(x=>x.id===id); if(!q) return;
  openModal('Preview Question #'+id, `
    <div class="card">
      <div><b>${q.section}</b> ‚Ä¢ ${q.category} ‚Ä¢ ${q.difficulty} ‚Ä¢ ${q.access}</div>
      <p style="margin-top:8px">${escapeHtml(q.stem)}</p>
      ${q.imageUrl?`<img src="${q.imageUrl}" class="img-preview" style="margin-top:6px">`:''}
      <ol style="margin-top:10px">
        ${q.options.map((o,i)=>`<li style="margin:6px 0"><b>${String.fromCharCode(65+i)}.</b> ${escapeHtml(o)}<br><span class="muted">Why: ${escapeHtml(q.explanations[i])}</span></li>`).join('')}
      </ol>
      <div style="margin-top:10px"><span class="badge badge-green">Correct: ${String.fromCharCode(65+q.correctIndex)}</span></div>
    </div>
  `);
}
function deleteQuestion(id){
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  if(!confirm('Delete question #'+id+' ?')) return;
  state.questions=state.questions.filter(q=>q.id!==id);
  showBank(); audit('questions.delete:'+id);
}

/* ============================== UCY PORTAL (student with YEAR selection) ============================== */
function showUCYPortal(){
  if(!state.currentUser){ showLogin(); return; }
  if(state.currentUser.role==='ucy_tutor'||isSuperadmin()){ showUCYTutorWorkspace(); return; }
  const c=document.getElementById('mainContent');
  const stud=state.students.find(s=>s.email===state.currentUser.email) || {};
  c.innerHTML=`
    <div>
      <div class="chip">UCY Student Portal</div>
      <div class="card">
        <h3>My Academic Profile</h3>
        <table class="table"><tbody>
          <tr><td><b>Student ID</b></td><td>${stud.studentId||'‚Äî'}</td></tr>
          <tr><td><b>Name</b></td><td>${escapeHtml(stud.name||state.currentUser.name)}</td></tr>
          <tr><td><b>Email</b></td><td>${escapeHtml(state.currentUser.email)}</td></tr>
          <tr><td><b>Course</b></td><td>${escapeHtml(stud.course||'MBBS')}</td></tr>
          <tr><td><b>Year</b></td><td>
            <select id="ucyYearSel" class="searchbar" style="max-width:160px">
              <option value="">Select Year</option>${[1,2,3,4,5,6].map(y=>`<option ${String(stud.year||'')===String(y)?'selected':''}>${y}</option>`).join('')}
            </select>
            <button class="btn btn-success" onclick="saveStudentYear()">Save</button>
          </td></tr>
        </tbody></table>
      </div>
      <div class="card" style="margin-top:10px">
        <h3>UCY Materials</h3>
        ${renderMaterialsFilterBar('student')}
        <div id="materialsTable"></div>
      </div>
    </div>`;
  renderMaterialsTable('student');
}
function saveStudentYear(){
  const year=document.getElementById('ucyYearSel').value;
  let stud=state.students.find(s=>s.email===state.currentUser.email);
  if(!stud){
    stud={ studentId:'S-'+(2000+state.students.length+1), name:state.currentUser.name, email:state.currentUser.email, year:year, course:'MBBS', notes:'' };
    state.students.push(stud);
  }else{
    stud.year=year;
  }
  alert('Year saved.');
}

/* ============================== UCY TUTOR WORKSPACE ============================== */
function showUCYTutorWorkspace(){
  if(!state.currentUser){ showLogin(); return; }
  if(!(state.currentUser.role==='ucy_tutor'||isSuperadmin())){ showUCYPortal(); return; }
  const c=document.getElementById('mainContent');
  c.innerHTML=`
    <div>
      <div class="chip">UCY Tutor Workspace</div>
      <div class="tabbar">
        <button class="tab-btn active" onclick="switchTab(event,'tutor_docs')">Teaching Docs</button>
        <button class="tab-btn" onclick="switchTab(event,'tutor_bulk')">Bulk Q Import</button>
      </div>

      <div id="tutor_docs" class="tab-content active">
        <div class="card">
          <div class="u-row">
            <div>
              <h3>Upload & Tag Materials</h3>
              <div class="u-row" style="margin-top:6px">
                <div><label>Specialty</label>${renderSpecialtySelect('uploadSpecialty')}</div>
                <div><label>Subspecialty</label><select id="uploadSubspecialty" class="searchbar"><option value="">‚Äî Select specialty first ‚Äî</option></select></div>
              </div>
              <div class="u-row" style="margin-top:6px">
                <div><label>Notes (optional)</label><input id="uploadNotes" class="searchbar" placeholder="e.g., Week 3 cardio ward round"></div>
              </div>
            </div>
            <div style="display:flex;gap:8px;align-items:flex-end;justify-content:flex-end">
              ${hasPerm('ucy.tutor.upload')?`<label class="btn btn-secondary" style="cursor:pointer">Select Files
                <input type="file" multiple onchange="ucyUploadDocsTagged(event)" accept=".ppt,.pptx,.pdf,.doc,.docx,.xls,.xlsx,.csv,.png,.jpg,.jpeg,.gif,.zip" style="display:none"></label>`:''}
              <button class="btn btn-success" onclick="downloadUCYDocsList()">Export List (CSV)</button>
            </div>
          </div>
          <div class="card" style="margin-top:10px">
            <h3>Browse Materials</h3>
            ${renderMaterialsFilterBar('tutor')}
            <div id="materialsTable"></div>
          </div>
        </div>
      </div>

      <div id="tutor_bulk" class="tab-content">
        <div class="card">
          <h3>Bulk Import UCY Questions (CSV)</h3>
          <div style="margin:6px 0">
            <button class="btn btn-secondary" onclick="downloadBulkTemplate()">Download Template</button>
            ${hasPerm('ucy.tutor.bulk_qs')?`<label class="btn btn-primary" style="cursor:pointer">Import CSV<input type="file" accept=".csv" onchange="importBulkQuestions(event)" style="display:none"></label>`:''}
          </div>
          <div class="card" style="margin-top:10px">
            <b>Template headers</b>: <code>section,category,difficulty,stem,optionA,optionB,optionC,optionD,optionE,correct,expA,expB,expC,expD,expE</code>
          </div>
          <div id="bulkImportReport" style="margin-top:10px"></div>
        </div>
      </div>
    </div>`;
  const specSel=document.getElementById('uploadSpecialty');
  specSel.addEventListener('change',()=>populateSubspecialties('uploadSpecialty','uploadSubspecialty'));
  populateSubspecialties('uploadSpecialty','uploadSubspecialty');
  renderMaterialsTable('tutor');
}

/* ============================== MATERIALS helpers ============================== */
function renderSpecialtySelect(id){
  return `<select id="${id}" class="searchbar"><option value="">All / Not set</option>${Object.keys(SPECIALTIES).sort().map(s=>`<option value="${s}">${s}</option>`).join('')}</select>`;
}
function renderMaterialsFilterBar(mode){
  const prefix = mode==='tutor'?'tutor':'student';
  const types = ['All','pdf','ppt','pptx','doc','docx','xls','xlsx','csv','image','zip','other'];
  return `
    <div class="searchbar">
      <input id="${prefix}Search" placeholder="Search title/notes‚Ä¶" oninput="renderMaterialsTable('${mode}')">
      ${renderSpecialtySelect(`${prefix}Spec`)}
      <select id="${prefix}Subspec" onchange="renderMaterialsTable('${mode}')"><option value="">‚Äî Select specialty first ‚Äî</option></select>
      <select id="${prefix}Type" onchange="renderMaterialsTable('${mode}')">
        ${types.map(t=>`<option value="${t}">${t.charAt(0).toUpperCase()+t.slice(1)}</option>`).join('')}
      </select>
      <button class="btn btn-secondary" onclick="resetMaterialFilters('${mode}')">Reset</button>
    </div>`;
}
function resetMaterialFilters(mode){
  const p = mode==='tutor'?'tutor':'student';
  document.getElementById(p+'Search').value='';
  document.getElementById(p+'Spec').value='';
  populateSubspecialties(p+'Spec', p+'Subspec');
  document.getElementById(p+'Type').value='All';
  renderMaterialsTable(mode);
}
function getFilterVals(mode){
  const p = mode==='tutor'?'tutor':'student';
  const search=(document.getElementById(p+'Search')?.value||'').toLowerCase();
  const spec=document.getElementById(p+'Spec')?.value||'';
  const subspec=document.getElementById(p+'Subspec')?.value||'';
  const type=(document.getElementById(p+'Type')?.value||'All').toLowerCase();
  return {search,spec,subspec,type};
}
function renderMaterialsTable(mode){
  const p = mode==='tutor'?'tutor':'student';
  const specSel=document.getElementById(p+'Spec');
  if(specSel && !specSel._wired){
    specSel._wired=true;
    specSel.addEventListener('change',()=>{ populateSubspecialties(p+'Spec', p+'Subspec'); renderMaterialsTable(mode); });
  }
  const {search,spec,subspec,type}=getFilterVals(mode);
  const rows = state.ucyDocs.filter(d=>{
    const matchSearch=!search || (d.name?.toLowerCase().includes(search) || (d.notes||'').toLowerCase().includes(search));
    const matchSpec = !spec || d.specialty===spec;
    const matchSub = !subspec || d.subspecialty===subspec;
    const kind = fileKind(d);
    const matchType = type==='all' || kind===type;
    return matchSearch && matchSpec && matchSub && matchType;
  });
  const html=`
    <table class="table">
      <thead><tr><th>Title</th><th>Specialty</th><th>Subspecialty</th><th>Type</th><th>Size</th><th class="nowrap">Uploaded By</th><th class="nowrap">When</th><th>Actions</th></tr></thead>
      <tbody>${rows.length?rows.map(renderDocRow).join(''):`<tr><td colspan="8">No materials.</td></tr>`}</tbody>
    </table>`;
  const mount=document.getElementById('materialsTable'); if(mount) mount.innerHTML=html;
}
function renderDocRow(d){
  const who=state.users.find(u=>u.id===d.uploadedByUserId)?.email||'unknown';
  return `<tr>
    <td><div>${escapeHtml(d.name)}</div>${d.notes?`<div class="muted" style="font-size:12px">${escapeHtml(d.notes)}</div>`:''}</td>
    <td><span class="badge badge-green">${escapeHtml(d.specialty||'‚Äî')}</span></td>
    <td>${d.subspecialty?`<span class="badge badge-indigo">${escapeHtml(d.subspecialty)}</span>`:'‚Äî'}</td>
    <td>${escapeHtml(fileKind(d))}</td>
    <td>${((d.size||0)/1024).toFixed(1)} KB</td>
    <td class="nowrap">${escapeHtml(who)}</td>
    <td class="nowrap">${new Date(d.uploadedAt).toLocaleString()}</td>
    <td>
      <a class="btn btn-secondary" href="${d.url}" download>Download</a>
      ${(state.currentUser.role==='ucy_tutor'||isSuperadmin())?`<button class="btn btn-danger" onclick="deleteUCYDoc('${d.id}')">Delete</button>`:''}
    </td>
  </tr>`;
}
function populateSubspecialties(specId, subId, includeAll=true){
  const spec=document.getElementById(specId).value;
  const sub=document.getElementById(subId);
  const list= spec && SPECIALTIES[spec] ? SPECIALTIES[spec] : [];
  sub.innerHTML=(includeAll?`<option value="">${spec?'All subspecialties':'‚Äî Select specialty first ‚Äî'}</option>`:'')
    + list.map(x=>`<option value="${x}">${x}</option>`).join('');
}
function ucyUploadDocsTagged(e){
  if(!(state.currentUser.role==='ucy_tutor'||isSuperadmin())){ alert('No permission.'); return; }
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  const spec=document.getElementById('uploadSpecialty').value;
  if(!spec){ alert('Select a specialty first.'); return; }
  const subs=document.getElementById('uploadSubspecialty').value||'';
  const notes=document.getElementById('uploadNotes').value.trim();
  const files=[...e.target.files]; if(!files.length) return;
  files.forEach(f=>{
    state.ucyDocs.push({ id:'doc_'+Date.now()+'_'+Math.random().toString(16).slice(2), name:f.name, type:f.type||guessType(f.name), size:f.size, url:URL.createObjectURL(f), uploadedByUserId:state.currentUser.id, uploadedAt:Date.now(), specialty:spec, subspecialty:subs, notes });
  });
  renderMaterialsTable('tutor'); audit('ucy.doc.upload:'+files.length+' @'+spec+'/'+(subs||'-'));
}
function deleteUCYDoc(id){
  if(!(state.currentUser.role==='ucy_tutor'||isSuperadmin())) return;
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  if(confirm('Delete document?')){
    state.ucyDocs=state.ucyDocs.filter(d=>d.id!==id);
    const mode=(state.currentUser.role==='ucy_tutor'||isSuperadmin())?'tutor':'student';
    renderMaterialsTable(mode);
    audit('ucy.doc.delete:'+id);
  }
}
function fileKind(d){
  const nm=(d.name||'').toLowerCase(); const t=(d.type||'').toLowerCase();
  if(t.includes('pdf')||nm.endsWith('.pdf')) return 'pdf';
  if(t.includes('powerpoint')||/\.pptx?$/.test(nm)) return nm.endsWith('.pptx')?'pptx':'ppt';
  if(t.includes('msword')||/\.docx?$/.test(nm)) return nm.endsWith('.docx')?'docx':'doc';
  if(t.includes('spreadsheet')||/\.xlsx?$/.test(nm)) return nm.endsWith('.xlsx')?'xlsx':'xls';
  if(t.includes('csv')||nm.endsWith('.csv')) return 'csv';
  if(t.startsWith('image/')||/\.(png|jpe?g|gif)$/i.test(nm)) return 'image';
  if(t.includes('zip')||nm.endsWith('.zip')) return 'zip';
  return 'other';
}
function guessType(name){
  const ext=name.split('.').pop().toLowerCase();
  const map={ppt:'application/vnd.ms-powerpoint',pptx:'application/vnd.openxmlformats-officedocument.presentationml.presentation',pdf:'application/pdf',doc:'application/msword',docx:'application/vnd.openxmlformats-officedocument.wordprocessingml.document',xls:'application/vnd.ms-excel',xlsx:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',csv:'text/csv',png:'image/png',jpg:'image/jpeg',jpeg:'image/jpeg',gif:'image/gif',zip:'application/zip'};
  return map[ext]||'application/octet-stream';
}
function downloadUCYDocsList(){
  const headers=['name','specialty','subspecialty','type','size','uploadedBy','uploadedAt','notes'];
  const rows=state.ucyDocs.map(d=>[d.name,d.specialty||'',d.subspecialty||'',fileKind(d),(d.size||0),(state.users.find(u=>u.id===d.uploadedByUserId)?.email||''),new Date(d.uploadedAt).toISOString(),d.notes||'']);
  const csv=[headers.join(',') ,...rows.map(r=>r.map(csvEscape).join(','))].join('\n');
  triggerDownload('ucy_docs.csv',csv);
}

/* ============================== RANKINGS & ANALYTICS ============================== */
function getStudentYearByUserId(uid){ const u=state.users.find(x=>x.id===uid); if(!u) return ''; const s=state.students.find(st=>st.email===u.email); return s?.year||''; }
function computeUserAccuracy(uid, specialty=null){
  const attempts = state.attempts.filter(a=>a.userId===uid && (!specialty || a.category===specialty));
  if(!attempts.length) return null;
  const correct = attempts.filter(a=>a.correct).length;
  return Math.round((correct/attempts.length)*100);
}
function computeMeanAccuracy(filterFn){
  const atts = state.attempts.filter(filterFn||(()=>true));
  if(!atts.length) return null;
  const correct = atts.filter(a=>a.correct).length;
  return Math.round((correct/atts.length)*100);
}
function usersWhoAttempted(specialty=null){
  const set=new Set(state.attempts.filter(a=>!specialty || a.category===specialty).map(a=>a.userId));
  return [...set];
}
function rankUsers({specialty=null, year=null}={}){
  const ids = usersWhoAttempted(specialty);
  const rows = ids.map(uid=>{
    const yr=getStudentYearByUserId(uid)||'';
    if(year && String(yr)!==String(year)) return null;
    const attempts = state.attempts.filter(a=>a.userId===uid && (!specialty || a.category===specialty));
    if(!attempts.length) return null;
    const acc = Math.round(100*attempts.filter(a=>a.correct).length/attempts.length);
    return { uid, name: state.users.find(u=>u.id===uid)?.name||('User#'+uid), role: state.users.find(u=>u.id===uid)?.role||'', year: yr, attempts: attempts.length, acc };
  }).filter(Boolean);
  rows.sort((a,b)=> (b.acc-a.acc) || (b.attempts-a.attempts));
  return rows;
}
function showRankings(){
  if(!state.currentUser){ showLogin(); return; }
  const c=document.getElementById('mainContent');

  const meId=state.currentUser.id;
  const myAcc = computeUserAccuracy(meId);
  const myYear = getStudentYearByUserId(meId) || '';
  const overallMean = computeMeanAccuracy(()=>true);
  const yearMean = myYear? computeMeanAccuracy(a=>{
    const yr=getStudentYearByUserId(a.userId); return String(yr)===String(myYear);
  }) : null;

  const specRows = Object.keys(SPECIALTIES).sort().map(spec=>{
    const my = computeUserAccuracy(meId, spec);
    const mean = computeMeanAccuracy(a=>a.category===spec);
    const delta = (my!=null && mean!=null) ? (my-mean) : null;
    return {spec, my, mean, delta};
  }).filter(r=>r.my!=null || r.mean!=null);

  const yrOpts = ['All',1,2,3,4,5,6].map(y=>`<option value="${y}">${y}</option>`).join('');
  const specOpts = ['All',...Object.keys(SPECIALTIES).sort()].map(s=>`<option value="${s}">${s}</option>`).join('');

  c.innerHTML=`
    <div>
      <div class="chip">Rankings & Analytics</div>
      <div class="grid stats-grid" style="margin-top:10px">
        <div class="stat-card"><div class="stat-value">${overallMean!=null?overallMean+'%':'‚Äî'}</div><div class="stat-label">Overall Mean</div></div>
        <div class="stat-card"><div class="stat-value">${myAcc!=null?myAcc+'%':'‚Äî'}</div><div class="stat-label">Your Accuracy</div></div>
        <div class="stat-card"><div class="stat-value">${myYear||'‚Äî'}</div><div class="stat-label">Your Year (UCY)</div></div>
        <div class="stat-card"><div class="stat-value">${yearMean!=null?yearMean+'%':'‚Äî'}</div><div class="stat-label">Year Group Mean</div></div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <h3>Leaderboard</h3>
          <div class="u-row" style="max-width:640px">
            <div><label>Filter by Specialty</label>
              <select id="rk_spec" class="searchbar" onchange="renderLeaderboard()">${specOpts}</select>
            </div>
            <div><label>Filter by Year (UCY)</label>
              <select id="rk_year" class="searchbar" onchange="renderLeaderboard()">${yrOpts}</select>
            </div>
          </div>
        </div>
        <div id="leaderboardTable" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>My Per-Specialty Comparison</h3>
        <table class="table">
          <thead><tr><th>Specialty</th><th>Your %</th><th>Group Mean %</th><th>Œî You ‚àí Mean</th></tr></thead>
          <tbody>
            ${specRows.length? specRows.map(r=>{
              const deltaStr = r.delta==null?'‚Äî': (r.delta>0? `<span class="delta-up">+${r.delta}</span>` : r.delta<0? `<span class="delta-down">${r.delta}</span>` : '0');
              return `<tr>
                <td><b>${r.spec}</b></td>
                <td>${r.my!=null?r.my+'%':'‚Äî'}</td>
                <td>${r.mean!=null?r.mean+'%':'‚Äî'}</td>
                <td>${deltaStr}</td>
              </tr>`;
            }).join('') : `<tr><td colspan="4">No attempts yet. Do some questions to unlock analytics.</td></tr>`}
          </tbody>
        </table>
      </div>
    </div>`;

  renderLeaderboard();
}
function renderLeaderboard(){
  const specSel=document.getElementById('rk_spec')?.value||'All';
  const yearSel=document.getElementById('rk_year')?.value||'All';
  const specialty = specSel==='All'?null:specSel;
  const year = yearSel==='All'?null:yearSel;

  const rows = rankUsers({specialty, year});
  const mean = specialty? computeMeanAccuracy(a=>a.category===specialty) : computeMeanAccuracy(()=>true);

  const tbl = `
    <table class="table">
      <thead><tr><th>Rank</th><th>Name</th><th>Role</th><th>Year</th><th>Attempts</th><th>Accuracy</th><th>Œî vs Mean</th></tr></thead>
      <tbody>
        ${rows.length? rows.map((r,i)=>{
          const d = (mean!=null)? (r.acc - mean) : null;
          const deltaStr = d==null?'‚Äî': (d>0? `<span class="delta-up">+${d}</span>` : d<0? `<span class="delta-down">${d}</span>` : '0');
          const me = (r.uid===state.currentUser.id) ? ' <span class="badge badge-indigo">You</span>' : '';
          return `<tr>
            <td>${i+1}</td>
            <td><b>${escapeHtml(r.name)}</b>${me}</td>
            <td>${r.role}</td>
            <td>${r.year||'‚Äî'}</td>
            <td>${r.attempts}</td>
            <td>${r.acc}%</td>
            <td>${deltaStr}</td>
          </tr>`;
        }).join('') : `<tr><td colspan="7">No data yet.</td></tr>`}
      </tbody>
    </table>`;
  const mount=document.getElementById('leaderboardTable');
  if(mount) mount.innerHTML=tbl;
}

/* ============================== SUPER-ADMIN PANEL (sections) ============================== */
function showAdminPanel(){
  if(!(state.currentUser && (state.currentUser.role==='admin'||state.currentUser.role==='ucy_staff'))) { showDashboard(); return; }
  const c=document.getElementById('mainContent');
  c.innerHTML=`
    <div>
      <div class="chip">Super Admin Control Center</div>
      <div class="two-col" style="margin-top:10px">
        <div class="card">
          <h3>Sections</h3>
          <div class="u-row">
            <button class="btn btn-secondary" onclick="adminShow('overview')">Overview</button>
            <button class="btn btn-secondary" onclick="adminShow('announcements')">Announcements & Banners</button>
            <button class="btn btn-secondary" onclick="adminShow('users')">Users</button>
            <button class="btn btn-secondary" onclick="adminShow('permissions')">Roles & Permissions</button>
            <button class="btn btn-secondary" onclick="adminShow('features')">Feature Flags</button>
            <button class="btn btn-secondary" onclick="adminShow('taxonomy')">Taxonomy</button>
            <button class="btn btn-secondary" onclick="adminShow('audit')">Audit Log</button>
            <button class="btn btn-secondary" onclick="adminShow('maintenance')">Maintenance</button>
            <button class="btn btn-secondary" onclick="adminShow('backup')">Backup/Restore</button>
          </div>
        </div>
        <div id="adminContent"></div>
      </div>
    </div>`;
  adminShow('announcements');
}

function adminShow(section){
  const t=document.getElementById('adminContent');
  if(section==='overview'){
    t.innerHTML=`<div class="card"><h3>Overview</h3>
      <div class="grid stats-grid" style="margin-top:8px">
        <div class="stat-card"><div class="stat-value">${state.users.length}</div><div class="stat-label">Users</div></div>
        <div class="stat-card"><div class="stat-value">${state.ucyDocs.length}</div><div class="stat-label">UCY Materials</div></div>
        <div class="stat-card"><div class="stat-value">${state.questions.length}</div><div class="stat-label">Questions</div></div>
        <div class="stat-card"><div class="stat-value">${state.auditLog.length}</div><div class="stat-label">Audit Entries</div></div>
      </div></div>`;
  } else if(section==='announcements'){ t.innerHTML=renderAnnouncementsPanel();
  } else if(section==='users'){ t.innerHTML=renderUsersAdmin();
  } else if(section==='permissions'){ t.innerHTML=renderPermissionsMatrix();
  } else if(section==='features'){ t.innerHTML=renderFeatureFlags();
  } else if(section==='taxonomy'){ t.innerHTML=renderTaxonomyEditor();
  } else if(section==='audit'){ t.innerHTML=renderAuditLog();
  } else if(section==='maintenance'){ t.innerHTML=renderMaintenancePanel();
  } else if(section==='backup'){ t.innerHTML=renderBackupRestore();
  }
}

/* ------------------- Announcements panel ------------------- */
function renderAnnouncementsPanel(){
  const banners=state.features.banners||[];
  return `<div class="card"><h3>Announcements & Must-Read Banners</h3>
    <div class="card" style="margin-top:10px">
      <h4>Top Banner</h4>
      <div class="u-row" style="margin-top:8px"><div><label>Message</label><input id="ann_msg" class="searchbar" value="${escapeHtml(state.features.announcement||'')}" placeholder="e.g., OSCE mock this Saturday 09:00"></div></div>
      <div style="margin-top:8px"><button class="btn btn-success" onclick="saveAnnouncement()">Save</button> <button class="btn btn-danger" onclick="clearAnnouncement()">Clear</button></div>
    </div>
    <div class="card" style="margin-top:12px">
      <h4>Must-Read Banners</h4>
      <div class="u-row" style="margin-top:8px">
        <div><label>Title</label><input id="bn_title" class="searchbar"></div>
        <div><label>Audience</label><select id="bn_audience" class="searchbar"><option value="all">All</option><option value="ucy">UCY</option><option value="tutor">Tutors</option><option value="student">Students</option></select></div>
      </div>
      <div class="u-row">
        <div><label>Priority (1-5)</label><input id="bn_priority" type="number" min="1" max="5" value="3" class="searchbar"></div>
        <div><label>Starts (ISO)</label><input id="bn_start" class="searchbar" placeholder="YYYY-MM-DD"></div>
        <div><label>Ends (ISO)</label><input id="bn_end" class="searchbar" placeholder="YYYY-MM-DD"></div>
      </div>
      <div style="margin-top:8px"><label><input type="checkbox" id="bn_require" checked> Require acknowledgement to proceed</label></div>
      <div style="margin-top:8px"><label>Body (HTML allowed)</label><textarea id="bn_body" rows="6" class="searchbar" placeholder="<p>Policy...</p>"></textarea></div>
      <div style="margin-top:10px"><button class="btn btn-primary" onclick="createBanner()">Create Banner</button> <button class="btn btn-outline" onclick="queueMustReadBanners()">Preview As Current User</button></div>
      <div class="card" style="margin-top:12px">
        <h4>Existing</h4>
        <table class="table"><thead><tr><th>Title</th><th>Audience</th><th>Priority</th><th>Window</th><th>Require Ack</th><th>Actions</th></tr></thead><tbody>
          ${banners.length?banners.map(b=>`
            <tr><td><b>${escapeHtml(b.title)}</b></td><td>${b.audience}</td><td>${b.priority}</td><td>${b.startISO||'now'} ‚Üí ${b.endISO||'‚àû'}</td>
            <td>${b.requireAck?'<span class="badge badge-red">Yes</span>':'<span class="badge badge-green">No</span>'}</td>
            <td class="nowrap"><button class="btn btn-secondary" onclick="editBanner('${b.id}')">Edit</button>
            <button class="btn btn-outline" onclick="resetBannerAcks('${b.id}')">Reset Acks</button>
            <button class="btn btn-danger" onclick="deleteBanner('${b.id}')">Delete</button></td></tr>`).join(''):`<tr><td colspan="6">No banners.</td></tr>`}
        </tbody></table>
      </div>
    </div></div>`;
}
function saveAnnouncement(){ if(!isSuperadmin() && !hasPerm('sudo.announcements')){ alert('Missing permission'); return; } state.features.announcement=document.getElementById('ann_msg').value.trim(); persistLiveFlags(); updateAnnouncementBar(); audit('announcement.save'); }
function clearAnnouncement(){ state.features.announcement=''; persistLiveFlags(); updateAnnouncementBar(); audit('announcement.clear'); }
function createBanner(){
  if(!isSuperadmin() && !hasPerm('sudo.announcements')){ alert('Missing permission'); return; }
  const title=document.getElementById('bn_title').value.trim();
  const body=document.getElementById('bn_body').value.trim();
  const audience=document.getElementById('bn_audience').value;
  const priority=parseInt(document.getElementById('bn_priority').value,10)||3;
  const startISO=(document.getElementById('bn_start').value||'').trim()||null;
  const endISO=(document.getElementById('bn_end').value||'').trim()||null;
  const requireAck=document.getElementById('bn_require').checked;
  if(!title||!body){ alert('Title and body required.'); return; }
  const b={ id:'bn_'+Date.now()+'_'+Math.random().toString(16).slice(2), title, body, audience, priority, startISO, endISO, requireAck };
  state.features.banners=state.features.banners||[]; state.features.banners.push(b);
  persistLiveFlags(); audit('banner.create:'+title); adminShow('announcements');
}
function deleteBanner(id){ if(!confirm('Delete banner?')) return; state.features.banners=(state.features.banners||[]).filter(b=>b.id!==id); persistLiveFlags(); audit('banner.delete:'+id); adminShow('announcements'); }
function editBanner(id){
  const b=(state.features.banners||[]).find(x=>x.id===id); if(!b) return;
  openModal('Edit Banner', `
    <div class="u-row">
      <div><label>Title</label><input id="eb_title" class="searchbar" value="${escapeHtml(b.title)}"></div>
      <div><label>Audience</label><select id="eb_audience" class="searchbar">${['all','ucy','tutor','student'].map(a=>`<option ${b.audience===a?'selected':''}>${a}</option>`).join('')}</select></div>
    </div>
    <div class="u-row">
      <div><label>Priority</label><input id="eb_priority" type="number" min="1" max="5" value="${b.priority}" class="searchbar"></div>
      <div><label>Starts</label><input id="eb_start" class="searchbar" value="${b.startISO||''}"></div>
      <div><label>Ends</label><input id="eb_end" class="searchbar" value="${b.endISO||''}"></div>
    </div>
    <div style="margin-top:8px"><label><input type="checkbox" id="eb_require" ${b.requireAck?'checked':''}> Require acknowledgement</label></div>
    <div style="margin-top:8px"><label>Body (HTML)</label><textarea id="eb_body" rows="8" class="searchbar">${escapeHtml(b.body)}</textarea></div>
    <div style="margin-top:10px"><button class="btn btn-success" onclick="saveBanner('${b.id}')">Save</button> <button class="btn btn-outline" onclick="resetBannerAcks('${b.id}')">Reset Acks</button></div>
  `);
}
function saveBanner(id){
  const b=(state.features.banners||[]).find(x=>x.id===id); if(!b) return;
  b.title=document.getElementById('eb_title').value.trim();
  b.body=document.getElementById('eb_body').value.trim();
  b.audience=document.getElementById('eb_audience').value;
  b.priority=parseInt(document.getElementById('eb_priority').value,10)||3;
  b.startISO=(document.getElementById('eb_start').value||'').trim()||null;
  b.endISO=(document.getElementById('eb_end').value||'').trim()||null;
  b.requireAck=document.getElementById('eb_require').checked;
  persistLiveFlags(); audit('banner.update:'+id); closeModal(); adminShow('announcements');
}
function resetBannerAcks(id){
  if(!confirm('Reset acknowledgements for this banner?')) return;
  const prefix='bannerAck_';
  Object.keys(localStorage).forEach(k=>{ if(k.startsWith(prefix) && k.endsWith('_'+id)) localStorage.removeItem(k); });
  audit('banner.acks.reset:'+id); alert('Acknowledgements reset.');
}

/* ============================== MUST-READ BANNERS ENGINE ============================== */
let bannerQueue=[], bannerIndex=0;
function seedDemoBannerOnce(){
  if(localStorage.getItem('seededDemoBanner')) return;
  state.features.banners=state.features.banners||[];
  state.features.banners.push({ id:'bn_demo', title:'Assessment Conduct Update', body:'<p>Sharing bank questions is a breach. Accounts involved will be suspended.</p><ul><li>Applies immediately</li><li>Report breaches to admins</li></ul>', audience:'all', priority:4, startISO:null, endISO:null, requireAck:true });
  persistLiveFlags(); localStorage.setItem('seededDemoBanner','1');
}
function queueMustReadBanners(){ if(!state.currentUser) return; bannerQueue=getActiveBannersForUser(); bannerIndex=0; if(bannerQueue.length) showNextBanner(); }
function getActiveBannersForUser(){
  const role=state.currentUser?.role||'user'; const now=new Date();
  return (state.features.banners||[]).filter(b=>{
    if(b.audience==='ucy' && !['ucy_staff','ucy_tutor','ucy_student','admin'].includes(role)) return false;
    if(b.audience==='tutor' && role!=='ucy_tutor' && !isSuperadmin()) return false;
    if(b.audience==='student' && role!=='ucy_student') return false;
    if(b.startISO && new Date(b.startISO)>now) return false;
    if(b.endISO && new Date(b.endISO)<now) return false;
    if(localStorage.getItem(bannerAckKey(state.currentUser.email,b.id))) return false;
    return true;
  }).sort((a,b)=> (b.priority-a.priority) || (b.id.localeCompare(a.id)));
}
function bannerAckKey(email,id){ return `bannerAck_${email}_${id}`; }
function showNextBanner(){ if(bannerIndex>=bannerQueue.length){ hideBannerModal(); return; } const b=bannerQueue[bannerIndex]; bannerTitleEl.textContent=b.title; bannerBodyEl.innerHTML=b.body; document.getElementById('bannerAckChk').checked=false; toggleBannerAck(); bannerInfoEl.innerHTML=`<span class="pill">Audience: ${b.audience}</span> <span class="pill">Priority: ${b.priority}</span>`; bannerProgress.textContent=`${bannerIndex+1} of ${bannerQueue.length}`; showBannerModal(); }
function toggleBannerAck(){ const b=bannerQueue[bannerIndex]; if(!b) return; if(b.requireAck){ if(document.getElementById('bannerAckChk').checked){ bannerCloseBtn.classList.remove('btn-disabled'); bannerCloseBtn.disabled=false; } else { bannerCloseBtn.classList.add('btn-disabled'); bannerCloseBtn.disabled=true; } } else { bannerCloseBtn.classList.remove('btn-disabled'); bannerCloseBtn.disabled=false; } }
function ackAndCloseBanner(){ const b=bannerQueue[bannerIndex]; if(!b) return; if(b.requireAck && !document.getElementById('bannerAckChk').checked) return; localStorage.setItem(bannerAckKey(state.currentUser.email,b.id), JSON.stringify({ts:Date.now()})); audit('banner.ack:'+b.id); bannerIndex++; showNextBanner(); }
function skipBanner(){ const b=bannerQueue[bannerIndex]; if(b && b.requireAck){ alert('Acknowledgement required.'); return; } bannerIndex++; showNextBanner(); }
function showBannerModal(){ bannerModal.classList.add('show'); }
function hideBannerModal(){ bannerModal.classList.remove('show'); }

/* ============================== ADMIN helpers ============================== */
function renderUsersAdmin(){
  return `
    <div class="card">
      <h3>Users</h3>
      <div style="margin:8px 0">
        <button class="btn btn-outline" onclick="exportUsers()">Export Users (CSV)</button>
        <label class="btn btn-primary" style="cursor:pointer">Import Users (CSV)<input type="file" accept=".csv" onchange="importUsers(event)" style="display:none"></label>
        <button class="btn btn-success" onclick="openCreateUser()">Create User</button>
      </div>
      <table class="table">
        <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Super</th><th>Actions</th></tr></thead>
        <tbody>${state.users.map(u=>`
          <tr>
            <td>${u.id}</td><td>${escapeHtml(u.name)}</td><td class="mono">${escapeHtml(u.email)}</td><td>${u.role}</td>
            <td>${u.superadmin||u.permissions?.['*']?'<span class="badge badge-green">Yes</span>':'<span class="badge">No</span>'}</td>
            <td class="nowrap">
              <button class="btn btn-secondary" onclick="openEditUser(${u.id})">Edit</button>
              <button class="btn btn-warning" onclick="sudoAs(${u.id})">Impersonate</button>
              <button class="btn btn-outline" onclick="forcePasswordReset(${u.id})">Reset PW</button>
              <button class="btn btn-danger" onclick="deleteUserAdmin(${u.id})">Delete</button>
            </td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>`;
}
function openCreateUser(){
  openModal('Create User', `
    <div class="u-row">
      <div><label>Name</label><input id="cu_name" class="searchbar"></div>
      <div><label>Email</label><input id="cu_email" type="email" class="searchbar"></div>
      <div><label>Password</label><input id="cu_pw" type="password" class="searchbar"></div>
      <div><label>Role</label><select id="cu_role" class="searchbar">${Object.keys(ROLE_PRESETS).map(r=>`<option>${r}</option>`).join('')}</select></div>
    </div>
    <div style="margin-top:10px"><label><input type="checkbox" id="cu_super"> Grant Super-Admin (*)</label></div>
    <div style="margin-top:12px"><button class="btn btn-success" onclick="createUserSave()">Create</button></div>
  `);
}
function createUserSave(){
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  const name=document.getElementById('cu_name').value.trim();
  const email=document.getElementById('cu_email').value.trim();
  const pw=document.getElementById('cu_pw').value;
  const role=document.getElementById('cu_role').value;
  const sup=document.getElementById('cu_super').checked;
  if(!name||!email||!pw){ alert('All fields required.'); return; }
  if(state.users.find(u=>u.email===email)){ alert('Email exists.'); return; }
  const id=state.users.length?Math.max(...state.users.map(u=>u.id))+1:1;
  const user={id,name,email,password:pw,role,subscription:null,permissions:{...(ROLE_PRESETS[role]||{})},superadmin:!!sup};
  if(sup) user.permissions['*']=true;
  state.users.push(user); closeModal(); adminShow('users'); audit('users.create:'+email);
}
function openEditUser(id){
  const u=state.users.find(x=>x.id===id); if(!u) return;
  openModal('Edit User', `
    <div class="u-row">
      <div><label>Name</label><input id="eu_name" class="searchbar" value="${escapeHtml(u.name)}"></div>
      <div><label>Email</label><input id="eu_email" type="email" class="searchbar" value="${escapeHtml(u.email)}"></div>
      <div><label>Role</label><select id="eu_role" class="searchbar">${Object.keys(ROLE_PRESETS).map(r=>`<option ${u.role===r?'selected':''}>${r}</option>`).join('')}</select></div>
    </div>
    <div style="margin-top:10px"><label><input type="checkbox" id="eu_super" ${u.superadmin||u.permissions?.['*']?'checked':''}> Super-Admin (*)</label></div>
    <div class="card" style="margin-top:10px">
      <b>Direct Permissions</b>
      <div style="max-height:260px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin-top:6px">
        ${PERMISSION_CATALOG.map(p=>`<label style="display:inline-block;width:48%;margin:4px 0"><input type="checkbox" data-perm="${p}" ${u.permissions?.[p]?'checked':''}> ${p}</label>`).join('')}
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-success" onclick="saveUserEdits(${id})">Save</button>
      <button class="btn btn-outline" onclick="forcePasswordReset(${id})">Reset Password</button>
      <button class="btn btn-warning" onclick="sudoAs(${id})">Impersonate</button>
      <button class="btn btn-danger" onclick="deleteUserAdmin(${id})">Delete</button>
    </div>`);
}
function saveUserEdits(id){
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  const u=state.users.find(x=>x.id===id); if(!u) return;
  u.name=document.getElementById('eu_name').value.trim();
  u.email=document.getElementById('eu_email').value.trim();
  u.role=document.getElementById('eu_role').value;
  const sup=document.getElementById('eu_super').checked;
  const checked=[...modalBodyEl.querySelectorAll('input[type=checkbox][data-perm]')].filter(i=>i.checked).map(i=>i.getAttribute('data-perm'));
  const baseline={...(ROLE_PRESETS[u.role]||{})};
  u.permissions={...baseline};
  checked.forEach(p=>u.permissions[p]=true);
  u.superadmin=!!sup; if(sup) u.permissions['*']=true; else delete u.permissions['*'];
  closeModal(); adminShow('users'); audit('users.update:'+u.email);
}
function forcePasswordReset(id){
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  const u=state.users.find(x=>x.id===id); if(!u) return;
  const newPw=Math.random().toString(36).slice(2,10)+'A1!';
  u.password=newPw; audit('users.password.reset:'+u.email);
  alert('New password for '+u.email+': '+newPw);
}
function deleteUserAdmin(id){
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  const u=state.users.find(x=>x.id===id); if(!u) return;
  if(u.id===state.currentUser.id){ alert('Cannot delete your own session.'); return; }
  if(!confirm('Delete '+u.email+' ?')) return;
  state.users=state.users.filter(x=>x.id!==id);
  closeModal(); adminShow('users'); audit('users.delete:'+u.email);
}
function exportUsers(){
  const headers=['id','name','email','role','superadmin','subscription'];
  const rows=state.users.map(u=>[u.id,u.name,u.email,u.role,!!(u.superadmin||u.permissions?.['*']),u.subscription||'']);
  triggerDownload('users_export.csv',[headers.join(','),...rows.map(r=>r.map(csvEscape).join(','))].join('\n')); audit('users.export');
}
function importUsers(e){
  if(state.features.readOnly){ alert('Read-only mode enabled.'); return; }
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    const rows=r.result.split(/\r?\n/).filter(x=>x.trim()); rows.shift();
    let added=0; rows.forEach(line=>{
      const cols=splitCsv(line); if(!cols.length) return;
      const [id,name,email,role,superadmin,subscription]=cols;
      if(!email || state.users.find(u=>u.email===email)) return;
      const uid=state.users.length?Math.max(...state.users.map(u=>u.id))+1:1;
      const sup=(String(superadmin).toLowerCase()==='true');
      const user={id:uid,name:name||email,email,password:'changemeA1!',role:role||'user',subscription:subscription||null,permissions:{...(ROLE_PRESETS[role||'user']||{})},superadmin:sup};
      if(sup) user.permissions['*']=true; state.users.push(user); added++;
    });
    alert('Imported: '+added); audit('users.import:'+added); adminShow('users');
  };
  r.readAsText(f);
}
function renderPermissionsMatrix(){
  const groups={
    'Global/Sudo':['*','sudo.impersonate','sudo.maintenance','sudo.announcements','sudo.feature_flags','sudo.backup','sudo.restore','sudo.audit.view','sudo.taxonomy.edit'],
    'Users':['users.read','users.create','users.update','users.delete','users.password.reset','users.force.logout','users.export','users.import'],
    'Roles/Perms':['roles.read','roles.update','permissions.assign'],
    'Content':['questions.read','questions.create','questions.update','questions.delete','media.upload','media.delete'],
    'Plans/Billing':['plans.read','plans.create','plans.update','plans.delete','billing.view','billing.refund'],
    'Analytics/Logs':['analytics.view','logs.view'],
    'UCY':['ucy.staff.view','ucy.staff.edit','ucy.import','ucy.tutor.upload','ucy.tutor.manage_docs','ucy.tutor.bulk_qs']
  };
  return `
    <div class="card">
      <h3>Roles & Permissions</h3>
      ${Object.keys(ROLE_PRESETS).map(role=>{
        const base={...(ROLE_PRESETS[role]||{})};
        return `<div class="card" style="margin-top:10px">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <h4>Role: ${role}</h4>
            <label><input type="checkbox" ${base['*']?'checked':''} onchange="toggleRoleWildcard('${role}',this.checked)"> Wildcard (*)</label>
          </div>
          ${Object.entries(groups).map(([g,perms])=>`
            <div style="margin-top:6px"><b>${g}</b></div>
            <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:6px">
              ${perms.map(p=>`<label class="pill" style="background:#eef2ff;color:#3730a3"><input type="checkbox" ${base[p]?'checked':''} onchange="toggleRolePerm('${role}','${p}',this.checked)"> ${p}</label>`).join('')}
            </div>`).join('')}
        </div>`;
      }).join('')}
    </div>`;
}
function toggleRoleWildcard(role,checked){ if(state.features.readOnly){ alert('Read-only mode'); adminShow('permissions'); return; } if(!ROLE_PRESETS[role]) ROLE_PRESETS[role]={}; if(checked) ROLE_PRESETS[role]['*']=true; else delete ROLE_PRESETS[role]['*']; audit('roles.wildcard.'+(checked?'on':'off')+':'+role); }
function toggleRolePerm(role,perm,checked){ if(state.features.readOnly){ alert('Read-only mode'); adminShow('permissions'); return; } if(!ROLE_PRESETS[role]) ROLE_PRESETS[role]={}; if(checked) ROLE_PRESETS[role][perm]=true; else delete ROLE_PRESETS[role][perm]; audit('roles.perm.'+(checked?'on':'off')+':'+role+':'+perm); }
function renderFeatureFlags(){
  return `<div class="card"><h3>Feature Flags</h3>
    <div class="u-row" style="margin-top:6px">
      <label><input type="checkbox" ${state.features.maintenance?'checked':''} onchange="setFlag('maintenance',this.checked)"> Maintenance</label>
      <label><input type="checkbox" ${state.features.readOnly?'checked':''} onchange="setFlag('readOnly',this.checked)"> Read-Only</label>
      <label><input type="checkbox" ${state.features.ucysOnlyVisibleToUCY?'checked':''} onchange="setFlag('ucysOnlyVisibleToUCY',this.checked)"> UCY-only materials</label>
      <label><input type="checkbox" ${state.features.allowGeneralDownloadTutorDocs?'checked':''} onchange="setFlag('allowGeneralDownloadTutorDocs',this.checked)"> General downloads</label>
    </div></div>`;
}
function setFlag(k,v){ if(!isSuperadmin() && !hasPerm('sudo.feature_flags')){ alert('Missing permission'); return; } state.features[k]=!!v; persistLiveFlags(); updateAnnouncementBar(); audit('flag:'+k+'='+(!!v)); }
function persistLiveFlags(){ localStorage.setItem('appBackupLive', JSON.stringify({features:state.features})); }
function renderTaxonomyEditor(){
  return `<div class="card"><h3>Specialty Taxonomy</h3>
    <div class="u-row" style="margin-top:6px">
      <div><label>New Specialty</label><input id="tx_spec" class="searchbar" placeholder="e.g., Immunology"></div>
      <div><label>Initial Subspecialties</label><input id="tx_subs" class="searchbar" placeholder="Clinical, Lab"></div>
    </div>
    <div style="margin-top:8px">
      <button class="btn btn-success" onclick="taxonomyAdd()">Add</button>
      <button class="btn btn-outline" onclick="taxonomyExport()">Export</button>
      <label class="btn btn-primary" style="cursor:pointer">Import<input type="file" accept=".json" onchange="taxonomyImport(event)" style="display:none"></label>
    </div>
    <div class="card" style="margin-top:10px">
      <table class="table"><thead><tr><th>Specialty</th><th>Subspecialties</th><th>Actions</th></tr></thead><tbody>
        ${Object.keys(SPECIALTIES).sort().map(s=>`
          <tr><td><b>${escapeHtml(s)}</b></td><td>${SPECIALTIES[s].map(x=>`<span class="pill" style="margin:2px">${escapeHtml(x)}</span>`).join(' ')}</td>
          <td class="nowrap"><button class="btn btn-secondary" onclick="openEditSpecialty('${escapeJs(s)}')">Edit</button>
          <button class="btn btn-danger" onclick="taxonomyRemove('${escapeJs(s)}')">Remove</button></td></tr>`).join('')}
      </tbody></table>
    </div></div>`;
}
function taxonomyAdd(){ if(state.features.readOnly){ alert('Read-only'); return; } const spec=document.getElementById('tx_spec').value.trim(); const subs=(document.getElementById('tx_subs').value||'').split(',').map(x=>x.trim()).filter(Boolean); if(!spec){ alert('Specialty required'); return; } if(SPECIALTIES[spec]){ alert('Exists'); return; } SPECIALTIES[spec]=subs.length?subs:['General']; adminShow('taxonomy'); audit('taxonomy.add:'+spec); }
function taxonomyRemove(spec){ if(state.features.readOnly){ alert('Read-only'); return; } if(!confirm('Remove '+spec+' ?')) return; delete SPECIALTIES[spec]; adminShow('taxonomy'); audit('taxonomy.remove:'+spec); }
function openEditSpecialty(spec){ const list=SPECIALTIES[spec]||[]; openModal('Edit Specialty ‚Äî '+spec, `<textarea id="tx_edit_subs" class="searchbar" rows="6">${escapeHtml(list.join(', '))}</textarea><div style="margin-top:10px"><button class="btn btn-success" onclick="saveSpecialty('${escapeJs(spec)}')">Save</button></div>`); }
function saveSpecialty(spec){ if(state.features.readOnly){ alert('Read-only'); return; } const subs=(document.getElementById('tx_edit_subs').value||'').split(',').map(x=>x.trim()).filter(Boolean); SPECIALTIES[spec]=subs.length?subs:['General']; closeModal(); adminShow('taxonomy'); audit('taxonomy.update:'+spec); }
function taxonomyExport(){ triggerDownload('taxonomy.json', JSON.stringify(SPECIALTIES,null,2)); audit('taxonomy.export'); }
function taxonomyImport(e){ if(state.features.readOnly){ alert('Read-only'); return; } const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); Object.keys(obj).forEach(k=>{ if(Array.isArray(obj[k])) SPECIALTIES[k]=obj[k]; }); adminShow('taxonomy'); audit('taxonomy.import'); }catch{ alert('Invalid JSON'); } }; r.readAsText(f); }
function renderAuditLog(){
  return `<div class="card"><h3>Audit Log</h3>
    <table class="table"><thead><tr><th>Time</th><th>Event</th></tr></thead><tbody>
      ${state.auditLog.slice().reverse().map(a=>`<tr><td class="mono">${new Date(a.ts).toLocaleString()}</td><td class="mono">${escapeHtml(a.msg)}</td></tr>`).join('')}
    </tbody></table><div><button class="btn btn-danger" onclick="auditClear()">Clear</button></div></div>`;
}
function auditClear(){ if(state.features.readOnly){ alert('Read-only'); return; } if(!confirm('Clear audit log?')) return; state.auditLog=[]; adminShow('audit'); audit('audit.cleared'); }
function renderMaintenancePanel(){
  return `<div class="card"><h3>Maintenance</h3>
    <div class="u-row" style="margin-top:6px">
      <label><input type="checkbox" ${state.features.maintenance?'checked':''} onchange="setFlag('maintenance',this.checked)"> Maintenance</label>
      <label><input type="checkbox" ${state.features.readOnly?'checked':''} onchange="setFlag('readOnly',this.checked)"> Read-Only</label>
    </div>
    <div style="margin-top:10px">
      <button class="btn btn-warning" onclick="simulateErrorLog()">View Pseudo Error Log</button>
      <button class="btn btn-danger" onclick="dataWipe()">Factory Reset (demo)</button>
    </div>
    <div id="errorLogPane" class="card" style="margin-top:10px;display:none"></div></div>`;
}
function simulateErrorLog(){ const p=document.getElementById('errorLogPane'); p.style.display='block'; p.innerHTML=`<b>Error Log (simulated)</b><pre class="mono" style="overflow:auto;max-height:260px">[${new Date().toISOString()}] WARN  Slow import detected\n[${new Date().toISOString()}] INFO  Cache warm complete\n[${new Date().toISOString()}] ERROR S3 upload failed (demo)</pre>`; }
function dataWipe(){ if(!confirm('Factory reset demo data?')) return; state.users = state.users.filter(u=>u.role==='admin'); state.ucyDocs=[]; state.questions=state.questions.slice(0,2); state.students=[]; state.auditLog=[]; persistLiveFlags(); localStorage.removeItem('attemptsLog'); state.attempts=[]; alert('Wiped. Only admin remains.'); audit('factory.reset'); showAdminPanel(); }
function backupNow(){ const scrub=state.users.map(u=>({...u,password:'***'})); const snap={users:scrub,students:state.students,ucyDocs:state.ucyDocs,questions:state.questions,features:state.features,taxonomy:SPECIALTIES,attempts:state.attempts,ts:new Date().toISOString()}; triggerDownload('medquest_backup.json',JSON.stringify(snap,null,2)); audit('backup.create'); }
function restoreFromBackup(e){ if(state.features.readOnly){ alert('Read-only'); return; } const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const o=JSON.parse(r.result); if(o.users) state.users=o.users.map(u=>({...u,password:u.password==='***'?'changemeA1!':u.password})); if(o.students) state.students=o.students; if(o.ucyDocs) state.ucyDocs=o.ucyDocs; if(o.questions) state.questions=o.questions; if(o.features) state.features=o.features; if(o.taxonomy) Object.assign(SPECIALTIES,o.taxonomy); if(o.attempts) state.attempts=o.attempts; persistLiveFlags(); updateAnnouncementBar(); localStorage.setItem('attemptsLog', JSON.stringify(state.attempts)); alert('Restore complete'); audit('backup.restore'); showAdminPanel(); }catch{ alert('Invalid backup'); } }; r.readAsText(f); }
function renderBackupRestore(){
  return `<div class="card"><h3>Backup / Restore</h3>
    <div style="margin:6px 0">
      <button class="btn btn-success" onclick="backupNow()">Download Full Backup (JSON)</button>
      <label class="btn btn-primary" style="cursor:pointer">Restore<input type="file" accept=".json" onchange="restoreFromBackup(event)" style="display:none"></label>
    </div>
    <div class="muted">Includes users (passwords masked), docs meta, questions, flags, taxonomy, <b>attempts</b>.</div></div>`;
}

/* ============================== UTILITIES ============================== */
function openModal(title, html){ modalTitleEl.textContent=title; modalBodyEl.innerHTML=html; modalEl.style.display='flex'; }
function closeModal(){ modalEl.style.display='none'; modalBodyEl.innerHTML=''; }
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeJs(s){ return String(s).replace(/['"\\]/g,'\\$&'); }
function csvEscape(v){ const s=String(v??''); return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; }
function splitCsv(line){ const out=[]; let cur='',inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='\"'){ if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; } else inQ=!inQ; } else if(ch===',' && !inQ){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out; }
function triggerDownload(filename, content){ const blob=new Blob([content],{type:'application/octet-stream'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
function audit(msg){ try{ state.auditLog.push({ts:Date.now(), msg}); }catch(_){} }

/* ===== Bulk questions CSV template & import (referenced by buttons) ===== */
function downloadBulkTemplate(){
  const headers=['section','category','difficulty','stem','optionA','optionB','optionC','optionD','optionE','correct','expA','expB','expC','expD','expE'];
  const sample=['SCENARIO','Cardiology','Medium','Chest pain in 58M, next best step?','ECG','CXR','Troponin','Aspirin','Discharge','A','Initial triage tool','Not first-line','Diagnostic','Correct immediate therapy','Unsafe'];
  const csv=[headers.join(','), sample.map(csvEscape).join(',')].join('\n');
  triggerDownload('ucy_bulk_questions_template.csv',csv);
}
function importBulkQuestions(e){
  const f=e.target.files?.[0]; if(!f){ alert('No file.'); return; }
  const r=new FileReader();
  r.onload=()=>{
    const lines=r.result.split(/\r?\n/).filter(Boolean);
    const header=lines.shift().split(',');
    const required=['section','category','difficulty','stem','optionA','optionB','optionC','optionD','optionE','correct','expA','expB','expC','expD','expE'];
    const ok = required.every((h,i)=> (header[i]||'').trim().toLowerCase()===h);
    if(!ok){ alert('Header mismatch. Download template and try again.'); return; }
    let added=0, errors=0;
    lines.forEach((line,idx)=>{
      const cols=splitCsv(line);
      try{
        const [section,category,difficulty,stem,A,B,C,D,E,correct,expA,expB,expC,expD,expE]=cols;
        const map={'A':0,'B':1,'C':2,'D':3,'E':4};
        const correctIndex= map[String(correct).trim().toUpperCase()];
        if(!stem || correctIndex==null){ errors++; return; }
        const id=state.questions.length?Math.max(...state.questions.map(q=>q.id))+1:1;
        state.questions.push({
          id, section:section||'SCENARIO', access:'UCY', category:category||'General Practice / Family Medicine',
          difficulty:difficulty||'Medium', stem, imageUrl:null,
          options:[A,B,C,D,E], explanations:[expA,expB,expC,expD,expE], correctIndex
        });
        added++;
      }catch{ errors++; }
    });
    const mount=document.getElementById('bulkImportReport');
    if(mount) mount.innerHTML=`<div class="badge badge-green">Imported ${added} question(s). ${errors?errors+' error(s).':''}</div>`;
  };
  r.readAsText(f);
}

/* ===== Impersonation stubs (used by Admin buttons) ===== */
function sudoAs(uid){ if(!isSuperadmin()) return alert('Need super admin'); if(state.sudoOriginalUser) return alert('Already impersonating'); const u=state.users.find(x=>x.id===uid); if(!u) return; state.sudoOriginalUser=state.currentUser; state.currentUser=u; updateNavigation(); showDashboard(); audit('sudo.as:'+uid); }
function sudoRevert(){ if(!state.sudoOriginalUser) return; state.currentUser=state.sudoOriginalUser; state.sudoOriginalUser=null; updateNavigation(); showDashboard(); audit('sudo.revert'); }
</script>
 <!-- === Persistent Offline Storage (IndexedDB) ‚Äî paste this just BEFORE </body> === -->
<script>
(function(){
  const DB_NAME = 'medquest_db';
  const STORE = 'kv';
  const SNAP_KEY = 'snapshot_v1';
  let dbp, saving=false, dirty=false, loading=false;

  // --- tiny IndexedDB helpers ---
  function openDB(){
    if (dbp) return dbp;
    dbp = new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = ()=>{ req.result.createObjectStore(STORE); };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
    return dbp;
  }
  async function idbGet(key){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE, 'readonly');
      const st = tx.objectStore(STORE);
      const r = st.get(key);
      r.onsuccess = ()=> resolve(r.result||null);
      r.onerror = ()=> reject(r.error);
    });
  }
  async function idbPut(key, val){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE, 'readwrite');
      const st = tx.objectStore(STORE);
      const r = st.put(val, key);
      r.onsuccess = ()=> resolve(true);
      r.onerror = ()=> reject(r.error);
    });
  }

  // --- mark dirty + debounced save ---
  let saveTimer=null;
  function markDirty(){
    if (loading) return;
    dirty = true;
    if (saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(saveSnapshot, 800);
  }

  // --- what we persist (no passwords, no blob URLs) ---
  function buildSnapshot(){
    // Avoid storing blob: URLs; keep doc metadata only
    const ucyDocsMeta = (window.state?.ucyDocs||[]).map(d => {
      const {url, ...rest} = d;
      return rest;
    });
    return {
      users: scrubPasswords(window.state?.users||[]),
      students: window.state?.students||[],
      ucyDocs: ucyDocsMeta,
      questions: window.state?.questions||[],
      attempts: window.state?.attempts||[],
      features: window.state?.features||{},
      taxonomy: window.SPECIALTIES||{},
      banners: (window.state?.features?.banners||[]),
      ts: Date.now()
    };
  }
  function scrubPasswords(users){
    return users.map(u=>({ ...u, password: u.password ? '(persisted)' : '' }));
  }
  function ensureAdmin(users){
    if (!users.some(u=>u.role==='admin')) {
      users.push({
        id: users.length? Math.max(...users.map(x=>+x.id||0))+1 : 1,
        email:'admin@medquest.com', password:'admin123',
        role:'admin', name:'Admin User', subscription:'premium',
        permissions:{'*':true}, superadmin:true
      });
    }
  }

  async function saveSnapshot(){
    if (saving || !window.state) return;
    saving = true;
    try {
      const snap = buildSnapshot();
      await idbPut(SNAP_KEY, snap);
      // keep attempts mirrored in localStorage for your existing analytics
      try { localStorage.setItem('attemptsLog', JSON.stringify(window.state.attempts||[])); } catch(_){}
      dirty = false;
      console.log('[persist] saved to IndexedDB');
    } catch(e){
      console.warn('[persist] save failed', e);
    } finally {
      saving = false;
    }
  }

  async function loadSnapshot(){
    loading = true;
    try {
      const snap = await idbGet(SNAP_KEY);
      if (!snap) return false;

      // Merge into running app state & taxonomy
      if (window.state){
        if (Array.isArray(snap.users) && snap.users.length) window.state.users = snap.users;
        ensureAdmin(window.state.users);
        if (Array.isArray(snap.students)) window.state.students = snap.students;
        if (Array.isArray(snap.ucyDocs)) {
          // Re-inject dummy blob URLs so UI still has a link icon (no file bytes persisted here)
          window.state.ucyDocs = snap.ucyDocs.map(d => ({
            ...d,
            url: d.url || '' // not functional across refresh; see note below
          }));
        }
        if (Array.isArray(snap.questions) && snap.questions.length) window.state.questions = snap.questions;
        if (Array.isArray(snap.attempts)) {
          window.state.attempts = snap.attempts;
          try { localStorage.setItem('attemptsLog', JSON.stringify(window.state.attempts)); } catch(_){}
        }
        if (snap.features) window.state.features = { ...window.state.features, ...snap.features };
      }
      if (snap.taxonomy && window.SPECIALTIES){
        try { Object.assign(window.SPECIALTIES, snap.taxonomy); } catch(_){}
      }
      // refresh top bar/nav if available
      try { window.updateAnnouncementBar && window.updateAnnouncementBar(); } catch(_){}
      try { window.updateNavigation && window.updateNavigation(); } catch(_){}
      console.log('[persist] loaded from IndexedDB');
      return true;
    } catch(e){
      console.warn('[persist] load failed', e);
      return false;
    } finally {
      loading = false;
    }
  }

  // --- Wrap mutating functions so they auto-save ---
  function wrapPersist(fnName){
    const old = window[fnName];
    if (typeof old !== 'function') return;
    window[fnName] = function(...args){
      const out = old.apply(this, args);
      // If it returned a Promise, save when it settles
      if (out && typeof out.then === 'function'){
        return out.finally(()=>markDirty());
      }
      markDirty();
      return out;
    };
  }

  function installWrappers(){
    [
      // users
      'handleRegister','handleLogin','logout',
      'openCreateUser','createUserSave','openEditUser','saveUserEdits','forcePasswordReset','deleteUserAdmin',
      // questions
      'openAddQuestion','saveQuestion','deleteQuestion',
      // docs
      'ucyUploadDocsTagged','deleteUCYDoc',
      // attempts + quiz
      'logAttempt',
      // banners & announcements & flags
      'saveAnnouncement','clearAnnouncement','createBanner','saveBanner','deleteBanner','resetBannerAcks','setFlag',
      // taxonomy
      'taxonomyAdd','taxonomyRemove','saveSpecialty',
      // backup/restore
      'restoreFromBackup'
    ].forEach(wrapPersist);

    // Also autosave every few seconds if dirty (belts & braces)
    setInterval(()=>{ if (dirty && !saving) saveSnapshot(); }, 3000);

    // Save on unload (best-effort)
    window.addEventListener('beforeunload', ()=>{ if (dirty) saveSnapshot(); }, {capture:true});
  }

  // boot after your main app has defined window.state et al.
  function boot(){
    if (window.state && window.SPECIALTIES){
      loadSnapshot().then(()=>{
        installWrappers();
        // do an initial save so new installs get a baseline snapshot
        markDirty();
      });
    } else {
      // try again shortly if app JS hasn‚Äôt finished
      setTimeout(boot, 200);
    }
  }
  boot();
})();
</script>

</body>
</html>

